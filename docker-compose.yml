version: "3.9"

services:
  # -----------------------------
  # Django backend (ASGI + Channels)
  # -----------------------------
  backend:
    build: ./backend
    container_name: home_automation_backend
    # IMPORTANT: use ASGI server (daphne) instead of runserver
    command: daphne -b 0.0.0.0 -p 8002 home_automation_backend.asgi:application
    # ^ replace "home_automation_backend.asgi:application" with your actual ASGI module
    #   e.g. "config.asgi:application" if your project is named "config"
    ports:
      - "8002:8002"
    volumes:
      - ./backend:/app
    environment:
      - DJANGO_DEBUG=1
      - DJANGO_SECRET_KEY=changeme
      - DJANGO_ALLOWED_HOSTS=*
      - DJANGO_CORS_ORIGINS=http://localhost:3003
      # Pointers to test infra
      - MQTT_BROKER_HOST=mqtt
      - MQTT_BROKER_PORT=1883
      - OPCUA_ENDPOINT=opc.tcp://opcua-sim:4840/freeopcua/server/
      # Channels / Redis
      - CHANNEL_REDIS_HOST=redis
    depends_on:
      - mqtt
      - opcua-sim
      - redis

  # -----------------------------
  # React frontend
  # -----------------------------
  frontend:
    build: ./frontend
    container_name: home_automation_frontend
    command: ["npm", "start"]          # run webpack dev server
    working_dir: /app
    ports:
      - "3003:3003"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - PORT=3003
      - REACT_APP_API_BASE_URL=http://localhost:8002/api
    depends_on:
      - backend

  # -----------------------------
  # MQTT broker (Eclipse Mosquitto)
  # -----------------------------
  mqtt:
    image: eclipse-mosquitto:2
    container_name: home_automation_mqtt
    ports:
      - "1883:1883"   # MQTT
      - "9001:9001"   # Websockets (if enabled in config)
    volumes:
      - ./infra/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  # Simple MQTT simulator publishing random sensor values
  mqtt-sim:
    image: python:3.12-slim
    container_name: home_automation_mqtt_sim
    working_dir: /app
    depends_on:
      - backend
      - mqtt
      - redis
    environment:
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
    volumes:
      - ./infra/mqtt_sim.py:/app/mqtt_sim.py:ro
    command: >
      bash -c "pip install --no-cache-dir paho-mqtt && python mqtt_sim.py"

  # -----------------------------
  # OPC UA simulation server
  # -----------------------------
  opcua-sim:
    image: python:3.12-slim
    container_name: home_automation_opcua
    working_dir: /app
    ports:
      - "4840:4840"   # OPC UA endpoint
    volumes:
      - ./infra/opcua_sim.py:/app/opcua_sim.py:ro
    command: >
      bash -c "pip install --no-cache-dir asyncua && python opcua_sim.py"

  # -----------------------------
  # MQTT worker (Django mgmt cmd consuming MQTT)
  # -----------------------------
  mqtt_worker:
    build: ./backend
    container_name: home_automation_mqtt_worker
    command: python manage.py run_mqtt_worker
    environment:
      - DJANGO_DEBUG=1
      - DJANGO_SECRET_KEY=changeme
      - DJANGO_ALLOWED_HOSTS=*
      - DJANGO_CORS_ORIGINS=http://localhost:3003
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
      # Same Redis host as backend so group_send reaches websockets
      - CHANNEL_REDIS_HOST=redis
    volumes:
      - ./backend:/app
    depends_on:
      - backend
      - mqtt
      - redis

  # -----------------------------
  # Redis for Channels (shared channel layer)
  # -----------------------------
  redis:
    image: redis:7-alpine
    container_name: home_automation_redis
    ports:
      - "6379:6379"